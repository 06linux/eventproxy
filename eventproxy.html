<!DOCTYPE html>
<html>
<head>
  <title>eventproxy.js</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" type="text/css" href="assets/doxco.css" />
  <link rel="stylesheet" type="text/css" href="assets/github.css" />
</head>
<body>
<div id="container">
  <div id="background"></div>
  <ul class="sections">
    <li id="title">
      <div class="docs">
        <h1>eventproxy.js</h1>
      </div>
    </li>
  
    <li id="section-1">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-1" class="pilcrow">&#182;</a>
        </div>
        <p>EventProxy. An implementation of task/event based asynchronous pattern.<br />A module that can be mixed in to <em>any object</em> in order to provide it with custom events.<br />You may <code>bind</code> or <code>unbind</code> a callback function to an event;<br /><code>trigger</code>-ing an event fires all callbacks in succession.<br />Examples:</p><pre><code class="lang-js">var render = function (template, resources) {};
var proxy = new EventProxy();
proxy.assign(&quot;template&quot;, &quot;l10n&quot;, render);
proxy.trigger(&quot;template&quot;, template);
proxy.trigger(&quot;l10n&quot;, resources);
</code></pre>

      </div>
      
      <div class="code">
        <pre><span class="hljs-keyword">var</span> EventProxy = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">if</span> (!(<span class="hljs-keyword">this</span> <span class="hljs-keyword">instanceof</span> EventProxy)) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> EventProxy();
    }
    <span class="hljs-keyword">this</span>._callbacks = {};
    <span class="hljs-keyword">this</span>._fired = {};
  };</pre>
      </div>
      
    </li>
  
    <li id="section-2">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-2" class="pilcrow">&#182;</a>
        </div>
        <p>Bind an event, specified by a string name, <code>ev</code>, to a <code>callback</code> function.<br />Passing <strong>ALL_EVENT</strong> will bind the callback to all events fired.<br />Examples:</p><pre><code class="lang-js">var proxy = new EventProxy();
proxy.addListener(&quot;template&quot;, function (event) {
  // TODO
});
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.addListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, callback)</span> {</span>
    debug(<span class="hljs-string">'Add listener for %s'</span>, ev);
    <span class="hljs-keyword">this</span>._callbacks[ev] = <span class="hljs-keyword">this</span>._callbacks[ev] || [];
    <span class="hljs-keyword">this</span>._callbacks[ev].push(callback);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-3">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-3" class="pilcrow">&#182;</a>
        </div>
        <p><code>addListener</code> alias, <code>bind</code></p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.bind</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.addListener</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-4">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-4" class="pilcrow">&#182;</a>
        </div>
        <p><code>addListener</code> alias, <code>on</code></p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.on</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.addListener</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-5">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-5" class="pilcrow">&#182;</a>
        </div>
        <p><code>addListener</code> alias, <code>subscribe</code></p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.subscribe</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.addListener</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-6">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-6" class="pilcrow">&#182;</a>
        </div>
        <p>Bind an event, but put the callback into head of all callbacks.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.headbind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, callback)</span> {</span>
    debug(<span class="hljs-string">'Add listener for %s'</span>, ev);
    <span class="hljs-keyword">this</span>._callbacks[ev] = <span class="hljs-keyword">this</span>._callbacks[ev] || [];
    <span class="hljs-keyword">this</span>._callbacks[ev].unshift(callback);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-7">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-7" class="pilcrow">&#182;</a>
        </div>
        <p>Remove one or many callbacks.</p><ul>
<li>If <code>callback</code> is null, removes all callbacks for the event.</li>
<li>If <code>eventname</code> is null, removes all bound callbacks for all events.</li>
</ul>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.removeListener = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname, callback)</span> {</span>
    <span class="hljs-keyword">var</span> calls = this._callbacks;
    <span class="hljs-keyword">if</span> (!eventname) {
      debug(<span class="hljs-string">'Remove all listeners'</span>);
      this._callbacks = {};
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">if</span> (!callback) {
        debug(<span class="hljs-string">'Remove all listeners of %s'</span>, eventname);
        calls[eventname] = [];
      } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span> = calls[eventname];
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">list</span>) {
          <span class="hljs-keyword">var</span> l = <span class="hljs-keyword">list</span>.length;
          <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; l; i++) {
            <span class="hljs-keyword">if</span> (callback === <span class="hljs-keyword">list</span>[i]) {
              debug(<span class="hljs-string">'Remove a listener of %s'</span>, eventname);
              <span class="hljs-keyword">list</span>[i] = <span class="hljs-keyword">null</span>;
            }
          }
        }
      }
    }
    <span class="hljs-keyword">return</span> this;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-8">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-8" class="pilcrow">&#182;</a>
        </div>
        <p><code>removeListener</code> alias, unbind</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.unbind</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.removeListener</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-9">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-9" class="pilcrow">&#182;</a>
        </div>
        <p>Remove all listeners. It equals unbind()<br />Just add this API for as same as Event.Emitter.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.removeAllListeners = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> {</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.unbind(event);
  };</pre>
      </div>
      
    </li>
  
    <li id="section-10">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-10" class="pilcrow">&#182;</a>
        </div>
        <p>Bind the ALL_EVENT event</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.bindForAll = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.bind(ALL_EVENT, callback);
  };</pre>
      </div>
      
    </li>
  
    <li id="section-11">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-11" class="pilcrow">&#182;</a>
        </div>
        <p>Unbind the ALL_EVENT event</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.unbindForAll = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">this</span>.unbind(ALL_EVENT, callback);
  };</pre>
      </div>
      
    </li>
  
    <li id="section-12">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-12" class="pilcrow">&#182;</a>
        </div>
        <p>Trigger an event, firing all bound callbacks. Callbacks are passed the<br />same arguments as <code>trigger</code> is, apart from the event name.<br />Listening for <code>&quot;all&quot;</code> passes the true event name as the first argument.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.trigger = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname, data)</span> {</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">list</span>, ev, callback, args, i, l;
    <span class="hljs-keyword">var</span> both = <span class="hljs-number">2</span>;
    <span class="hljs-keyword">var</span> calls = this._callbacks;
    debug(<span class="hljs-string">'Emit event %s with data %j'</span>, eventname, data);
    <span class="hljs-keyword">while</span> (both--) {
      ev = both ? eventname : ALL_EVENT;
      <span class="hljs-keyword">list</span> = calls[ev];
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">list</span>) {
        <span class="hljs-keyword">for</span> (i = <span class="hljs-number">0</span>, l = <span class="hljs-keyword">list</span>.length; i &lt; l; i++) {
          <span class="hljs-keyword">if</span> (!(callback = <span class="hljs-keyword">list</span>[i])) {
            <span class="hljs-keyword">list</span>.splice(i, <span class="hljs-number">1</span>);
            i--;
            l--;
          } <span class="hljs-keyword">else</span> {
            args = both ? SLICE.call(arguments, <span class="hljs-number">1</span>) : arguments;
            callback.apply(this, args);
          }
        }
      }
    }
    <span class="hljs-keyword">return</span> this;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-13">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-13" class="pilcrow">&#182;</a>
        </div>
        <p><code>trigger</code> alias</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.emit</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.trigger</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-14">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-14" class="pilcrow">&#182;</a>
        </div>
        <p><code>trigger</code> alias</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.fire</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.trigger</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-15">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-15" class="pilcrow">&#182;</a>
        </div>
        <p>Bind an event like the bind method, but will remove the listener after it was fired.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.once = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, callback)</span> {</span>
    <span class="hljs-keyword">var</span> self = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> wrapper = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      callback.apply(self, <span class="hljs-built_in">arguments</span>);
      self.unbind(ev, wrapper);
    };
    <span class="hljs-keyword">this</span>.bind(ev, wrapper);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };

  <span class="hljs-keyword">var</span> later = <span class="hljs-keyword">typeof</span> process !== <span class="hljs-string">'undefined'</span> &amp;&amp; process.nextTick || <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(fn)</span> {</span>
    setTimeout(fn, <span class="hljs-number">0</span>);
  };</pre>
      </div>
      
    </li>
  
    <li id="section-16">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-16" class="pilcrow">&#182;</a>
        </div>
        <p>emitLater<br />make emit async</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.emitLater = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> <span class="hljs-keyword">self</span> = this;
    <span class="hljs-keyword">var</span> args = arguments;
    later(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
      <span class="hljs-keyword">self</span>.trigger.apply(<span class="hljs-keyword">self</span>, args);
    });
  };</pre>
      </div>
      
    </li>
  
    <li id="section-17">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-17" class="pilcrow">&#182;</a>
        </div>
        <p>Bind an event, and trigger it immediately.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.immediate = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(ev, callback, data)</span> {</span>
    <span class="hljs-keyword">this</span>.bind(ev, callback);
    <span class="hljs-keyword">this</span>.trigger(ev, data);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-18">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-18" class="pilcrow">&#182;</a>
        </div>
        <p><code>immediate</code> alias</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.asap = EventProxy.prototype.immediate;

  <span class="hljs-keyword">var</span> _assign = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname1, eventname2, cb, once)</span> {</span>
    <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> argsLength = <span class="hljs-built_in">arguments</span>.length;
    <span class="hljs-keyword">var</span> times = <span class="hljs-number">0</span>;
    <span class="hljs-keyword">var</span> flag = {};
</pre>
      </div>
      
    </li>
  
    <li id="section-19">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-19" class="pilcrow">&#182;</a>
        </div>
        <p>Check the arguments length.</p>
      </div>
      
      <div class="code">
        <pre>    <span class="hljs-keyword">if</span> (argsLength &lt; <span class="hljs-number">3</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }

    <span class="hljs-keyword">var</span> events = SLICE.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">2</span>);
    <span class="hljs-keyword">var</span> callback = <span class="hljs-built_in">arguments</span>[argsLength - <span class="hljs-number">2</span>];
    <span class="hljs-keyword">var</span> isOnce = <span class="hljs-built_in">arguments</span>[argsLength - <span class="hljs-number">1</span>];
</pre>
      </div>
      
    </li>
  
    <li id="section-20">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-20" class="pilcrow">&#182;</a>
        </div>
        <p>Check the callback type.</p>
      </div>
      
      <div class="code">
        <pre>    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> callback !== <span class="hljs-string">"function"</span>) {
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    debug(<span class="hljs-string">'Assign listener for events %j, once is %s'</span>, events, !!isOnce);
    <span class="hljs-keyword">var</span> bind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      <span class="hljs-keyword">var</span> method = isOnce ? <span class="hljs-string">"once"</span> : <span class="hljs-string">"bind"</span>;
      proxy[method](key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
        proxy._fired[key] = proxy._fired[key] || {};
        proxy._fired[key].data = data;
        <span class="hljs-keyword">if</span> (!flag[key]) {
          flag[key] = <span class="hljs-literal">true</span>;
          times++;
        }
      });
    };

    <span class="hljs-keyword">var</span> length = events.length;
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; length; index++) {
      bind(events[index]);
    }

    <span class="hljs-keyword">var</span> _all = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(event)</span> {</span>
      <span class="hljs-keyword">if</span> (times &lt; length) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">if</span> (!flag[event]) {
        <span class="hljs-keyword">return</span>;
      }
      <span class="hljs-keyword">var</span> data = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; length; index++) {
        data.push(proxy._fired[events[index]].data);
      }
      <span class="hljs-keyword">if</span> (isOnce) {
        proxy.unbindForAll(_all);
      }
      debug(<span class="hljs-string">'Events %j all emited with data %j'</span>, events, data);
      callback.apply(<span class="hljs-literal">null</span>, data);
    };
    proxy.bindForAll(_all);
  };</pre>
      </div>
      
    </li>
  
    <li id="section-21">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-21" class="pilcrow">&#182;</a>
        </div>
        <p>Assign some events, after all events were fired, the callback will be executed once.</p><p>Examples:</p><pre><code class="lang-js">proxy.all(ev1, ev2, callback);
proxy.all([ev1, ev2], callback);
proxy.all(ev1, [ev2, ev3], callback);
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.all = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname1, eventname2, callback)</span> {</span>
    <span class="hljs-keyword">var</span> args = CONCAT.apply([], <span class="hljs-built_in">arguments</span>);
    args.push(<span class="hljs-literal">true</span>);
    _assign.apply(<span class="hljs-keyword">this</span>, args);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-22">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-22" class="pilcrow">&#182;</a>
        </div>
        <p><code>all</code> alias</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.assign</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.all</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-23">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-23" class="pilcrow">&#182;</a>
        </div>
        <p>Assign the only one &#39;error&#39; event handler.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.fail = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(callback)</span> {</span>
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
    that.once(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err)</span> {</span>
      that.unbind();</pre>
      </div>
      
    </li>
  
    <li id="section-24">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-24" class="pilcrow">&#182;</a>
        </div>
        <p>put all arguments to the error handler<br />      fail(function(err, args1, args2, ...){})</p>
      </div>
      
      <div class="code">
        <pre>      callback.apply(<span class="hljs-literal">null</span>, <span class="hljs-built_in">arguments</span>);
    });
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-25">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-25" class="pilcrow">&#182;</a>
        </div>
        <p>Assign some events, after all events were fired, the callback will be executed first time.<br />Then any event that predefined be fired again, the callback will executed with the newest data.<br />Examples:</p><pre><code class="lang-js">proxy.tail(ev1, ev2, callback);
proxy.tail([ev1, ev2], callback);
proxy.tail(ev1, [ev2, ev3], callback);
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.tail = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> args = CONCAT.apply([], <span class="hljs-built_in">arguments</span>);
    args.push(<span class="hljs-literal">false</span>);
    _assign.apply(<span class="hljs-keyword">this</span>, args);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-26">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-26" class="pilcrow">&#182;</a>
        </div>
        <p><code>tail</code> alias, assignAll</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.assignAll</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.tail</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-27">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-27" class="pilcrow">&#182;</a>
        </div>
        <p><code>tail</code> alias, assignAlways</p>
      </div>
      
      <div class="code">
        <pre>EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.assignAlways</span> = EventProxy<span class="hljs-preprocessor">.prototype</span><span class="hljs-preprocessor">.tail</span><span class="hljs-comment">;</span></pre>
      </div>
      
    </li>
  
    <li id="section-28">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-28" class="pilcrow">&#182;</a>
        </div>
        <p>The callback will be executed after the event be fired N times.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.after = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname, times, callback)</span> {</span>
    <span class="hljs-keyword">if</span> (times === <span class="hljs-number">0</span>) {
      callback.call(<span class="hljs-literal">null</span>, []);
      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
    }
    <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>,
      firedData = [];
    <span class="hljs-keyword">this</span>._after = <span class="hljs-keyword">this</span>._after || {};
    <span class="hljs-keyword">var</span> group = eventname + <span class="hljs-string">'_group'</span>;
    <span class="hljs-keyword">this</span>._after[group] = {
      index: <span class="hljs-number">0</span>,
      results: []
    };
    debug(<span class="hljs-string">'After emit %s times, event %s\'s listenner will execute'</span>, times, eventname);
    <span class="hljs-keyword">var</span> all = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, data)</span> {</span>
      <span class="hljs-keyword">if</span> (name === eventname) {
        times--;
        firedData.push(data);
        <span class="hljs-keyword">if</span> (times &lt; <span class="hljs-number">1</span>) {
          debug(<span class="hljs-string">'Event %s was emit %s, and execute the listenner'</span>, eventname, times);
          proxy.unbindForAll(all);
          callback.apply(<span class="hljs-literal">null</span>, [firedData]);
        }
      }
      <span class="hljs-keyword">if</span> (name === group) {
        times--;
        proxy._after[group].results[data.index] = data.result;
        <span class="hljs-keyword">if</span> (times &lt; <span class="hljs-number">1</span>) {
          debug(<span class="hljs-string">'Event %s was emit %s, and execute the listenner'</span>, eventname, times);
          proxy.unbindForAll(all);
          callback.call(<span class="hljs-literal">null</span>, proxy._after[group].results);
        }
      }
    };
    proxy.bindForAll(all);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>;
  };</pre>
      </div>
      
    </li>
  
    <li id="section-29">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-29" class="pilcrow">&#182;</a>
        </div>
        <p>The <code>after</code> method&#39;s helper. Use it will return ordered results.<br />If you need manipulate result, you need callback<br />Examples:</p><pre><code class="lang-js">var ep = new EventProxy();
ep.after(&#39;file&#39;, files.length, function (list) {
  // Ordered results
});
for (var i = 0; i &lt; files.length; i++) {
  fs.readFile(files[i], &#39;utf-8&#39;, ep.group(&#39;file&#39;));
}
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.group = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname, callback)</span> {</span>
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">var</span> group = eventname + <span class="hljs-string">'_group'</span>;
    <span class="hljs-keyword">var</span> index = that._after[group].index;
    that._after[group].index++;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> {</span>
      <span class="hljs-keyword">if</span> (err) {</pre>
      </div>
      
    </li>
  
    <li id="section-30">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-30" class="pilcrow">&#182;</a>
        </div>
        <p>put all arguments to the error handler</p>
      </div>
      
      <div class="code">
        <pre>        <span class="hljs-keyword">return</span> that.emit.apply(that, [<span class="hljs-string">'error'</span>].concat(SLICE.call(arguments)));
      }
      that.emit(<span class="hljs-keyword">group</span>, {
        <span class="hljs-keyword">index</span>: <span class="hljs-keyword">index</span>,</pre>
      </div>
      
    </li>
  
    <li id="section-31">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-31" class="pilcrow">&#182;</a>
        </div>
        <p>callback(err, args1, args2, ...)</p>
      </div>
      
      <div class="code">
        <pre>        result: callback ? callback.apply(<span class="hljs-literal">null</span>, SLICE.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>)) : data
      });
    };
  };</pre>
      </div>
      
    </li>
  
    <li id="section-32">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-32" class="pilcrow">&#182;</a>
        </div>
        <p>The callback will be executed after any registered event was fired. It only executed once.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.any = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> proxy = <span class="hljs-keyword">this</span>,
      callback = <span class="hljs-built_in">arguments</span>[<span class="hljs-built_in">arguments</span>.length - <span class="hljs-number">1</span>],
      events = SLICE.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">0</span>, -<span class="hljs-number">1</span>),
      _eventname = events.join(<span class="hljs-string">"_"</span>);

    debug(<span class="hljs-string">'Add listenner for Any of events %j emit'</span>, events);
    proxy.once(_eventname, callback);

    <span class="hljs-keyword">var</span> _bind = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(key)</span> {</span>
      proxy.bind(key, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(data)</span> {</span>
        debug(<span class="hljs-string">'One of events %j emited, execute the listenner'</span>);
        proxy.trigger(_eventname, {<span class="hljs-string">"data"</span>: data, eventname: key});
      });
    };

    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> index = <span class="hljs-number">0</span>; index &lt; events.length; index++) {
      _bind(events[index]);
    }
  };</pre>
      </div>
      
    </li>
  
    <li id="section-33">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-33" class="pilcrow">&#182;</a>
        </div>
        <p>The callback will be executed when the event name not equals with assigned event.</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.<span class="hljs-keyword">not</span> = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(eventname, callback)</span></span> {
    var proxy = this;
    <span class="hljs-built_in">debug</span>(<span class="hljs-string">'Add listenner for not event %s'</span>, eventname);
    proxy.bindForAll(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(name, data)</span></span> {
      <span class="hljs-keyword">if</span> (name !== eventname) {
        <span class="hljs-built_in">debug</span>(<span class="hljs-string">'listenner execute of event %s emit, but not event %s.'</span>, name, eventname);
        callback(data);
      }
    });
  };</pre>
      </div>
      
    </li>
  
    <li id="section-34">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-34" class="pilcrow">&#182;</a>
        </div>
        <p>Success callback wrapper, will handler err for you.</p><pre><code class="lang-js">fs.readFile(&#39;foo.txt&#39;, ep.done(&#39;content&#39;));

// equal to =&gt;

fs.readFile(&#39;foo.txt&#39;, function (err, content) {
  if (err) {
    return ep.emit(&#39;error&#39;, err);
  }
  ep.emit(&#39;content&#39;, content);
});
</code></pre>
<pre><code class="lang-js">fs.readFile(&#39;foo.txt&#39;, ep.done(&#39;content&#39;, function (content) {
  return content.trim();
}));

// equal to =&gt;

fs.readFile(&#39;foo.txt&#39;, function (err, content) {
  if (err) {
    return ep.emit(&#39;error&#39;, err);
  }
  ep.emit(&#39;content&#39;, content.trim());
});
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.done = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(handler, callback)</span> {</span>
    <span class="hljs-keyword">var</span> that = <span class="hljs-keyword">this</span>;
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> {</span>
      <span class="hljs-keyword">if</span> (err) {</pre>
      </div>
      
    </li>
  
    <li id="section-35">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-35" class="pilcrow">&#182;</a>
        </div>
        <p>put all arguments to the error handler</p>
      </div>
      
      <div class="code">
        <pre><span class="hljs-command">        return</span> <span class="hljs-keyword">that</span>.emit.apply(<span class="hljs-keyword">that</span>, ['<span class="hljs-keyword">error</span>'].concat(SLICE.call(arguments)));
      }
</pre>
      </div>
      
    </li>
  
    <li id="section-36">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-36" class="pilcrow">&#182;</a>
        </div>
        <p>callback(err, args1, args2, ...)</p>
      </div>
      
      <div class="code">
        <pre>      <span class="hljs-keyword">var</span> args = SLICE.call(<span class="hljs-built_in">arguments</span>, <span class="hljs-number">1</span>);

      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> handler === <span class="hljs-string">'string'</span>) {</pre>
      </div>
      
    </li>
  
    <li id="section-37">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-37" class="pilcrow">&#182;</a>
        </div>
        <p>getAsync(query, ep.done(&#39;query&#39;));<br />        or<br />        getAsync(query, ep.done(&#39;query&#39;, function (data) {<br />          return data.trim();<br />        }));</p>
      </div>
      
      <div class="code">
        <pre>        <span class="hljs-keyword">if</span> (callback) {</pre>
      </div>
      
    </li>
  
    <li id="section-38">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-38" class="pilcrow">&#182;</a>
        </div>
        <p>only replace the args when it really return a result</p>
      </div>
      
      <div class="code">
        <pre>          <span class="hljs-keyword">return</span> that.emit(handler, callback.apply(<span class="hljs-keyword">null</span>, args));
        } <span class="hljs-keyword">else</span> {</pre>
      </div>
      
    </li>
  
    <li id="section-39">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-39" class="pilcrow">&#182;</a>
        </div>
        <p>put all arguments to the done handler<br />          //ep.done(&#39;some&#39;);<br />          //ep.on(&#39;some&#39;, function(args1, args2, ...){});</p>
      </div>
      
      <div class="code">
        <pre>          return that<span class="hljs-preprocessor">.emit</span><span class="hljs-preprocessor">.apply</span>(that, [handler]<span class="hljs-preprocessor">.concat</span>(args))<span class="hljs-comment">;</span>
        }
      }
</pre>
      </div>
      
    </li>
  
    <li id="section-40">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-40" class="pilcrow">&#182;</a>
        </div>
        <p>speed improve for mostly case: <code>callback(err, data)</code></p>
      </div>
      
      <div class="code">
        <pre>      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">arguments</span>.length &lt;= <span class="hljs-number">2</span>) {
        <span class="hljs-keyword">return</span> handler(data);
      }
</pre>
      </div>
      
    </li>
  
    <li id="section-41">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-41" class="pilcrow">&#182;</a>
        </div>
        <p>callback(err, args1, args2, ...)</p>
      </div>
      
      <div class="code">
        <pre>      <span class="hljs-operator"><span class="hljs-keyword">handler</span>.apply(<span class="hljs-keyword">null</span>, args);</span>
    };
  };</pre>
      </div>
      
    </li>
  
    <li id="section-42">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-42" class="pilcrow">&#182;</a>
        </div>
        <p>make done async</p>
      </div>
      
      <div class="code">
        <pre>EventProxy.prototype.doneLater = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(handler, callback)</span> {</span>
    <span class="hljs-keyword">var</span> _doneHandler = <span class="hljs-keyword">this</span>.done(handler, callback);
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">(err, data)</span> {</span>
      <span class="hljs-keyword">var</span> args = <span class="hljs-built_in">arguments</span>;
      later(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
        _doneHandler.apply(<span class="hljs-literal">null</span>, args);
      });
    };
  };</pre>
      </div>
      
    </li>
  
    <li id="section-43">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-43" class="pilcrow">&#182;</a>
        </div>
        <p>Create a new EventProxy<br />Examples:</p><pre><code class="lang-js">var ep = EventProxy.create();
ep.assign(&#39;user&#39;, &#39;articles&#39;, function(user, articles) {
  // do something...
});
// or one line ways: Create EventProxy and Assign
var ep = EventProxy.create(&#39;user&#39;, &#39;articles&#39;, function(user, articles) {
  // do something...
});
</code></pre>

      </div>
      
      <div class="code">
        <pre>EventProxy.create = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-params">()</span> {</span>
    <span class="hljs-keyword">var</span> ep = <span class="hljs-keyword">new</span> EventProxy();
    <span class="hljs-keyword">var</span> args = CONCAT.apply([], <span class="hljs-built_in">arguments</span>);
    <span class="hljs-keyword">if</span> (args.length) {
      <span class="hljs-keyword">var</span> errorHandler = args[args.length - <span class="hljs-number">1</span>];
      <span class="hljs-keyword">var</span> callback = args[args.length - <span class="hljs-number">2</span>];
      <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> errorHandler === <span class="hljs-string">'function'</span> &amp;&amp; <span class="hljs-keyword">typeof</span> callback === <span class="hljs-string">'function'</span>) {
        args.pop();
        ep.fail(errorHandler);
      }
      ep.assign.apply(ep, args);
    }
    <span class="hljs-keyword">return</span> ep;
  };
</pre>
      </div>
      
    </li>
  
    <li id="section-44">
      <div class="docs">
        
        <div class="pilwrap ">
          <a href="#section-44" class="pilcrow">&#182;</a>
        </div>
        <p>Backwards compatibility</p>
      </div>
      
      <div class="code">
        <pre>  EventProxy.EventProxy = EventProxy;

  <span class="hljs-keyword">return</span> EventProxy;
});</pre>
      </div>
      
    </li>
  
  </ul>
</div>
</body>
</html>
